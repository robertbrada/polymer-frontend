<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/polymerfire/firebase-document.html">
<link rel="import" href="/custom_components/custom-button.html">

<link rel="import" href="/behaviors/input-validation-behavior.html">


<dom-module id="account-view">
    <template>
        <style include="custom-button">

            :host {
                display: block;
                background-color: white;
            }

            h2 {
                font-size: 13px;
            }

            custom-button {
                margin-top: 20px;
            }

            p {
                margin-bottom: 0px;
            }

            .main-frame {
                transition: opacity 0.5s;
                margin: 0 auto;
                padding: 0 24px 48px 24px;
                max-width: 900px;
                overflow: hidden;
            }

            .grid {
                margin-top: 40px;
                @apply(--layout-horizontal);
            }

            .grid > section {
                @apply(--layout-flex);
            }

            .grid > section:not(:first-child) {
                margin-left: 80px;
            }

            @media (max-width: 767px) {

                .grid {
                    display: block;
                    margin-top: 0;
                }

                .grid > section:not(:first-child) {
                    margin-left: 0;
                }

            }
        </style>

        <firebase-document app-name="doctor-appointment-system" path="/users/{{user.uid}}/name"
                           data="{{nameData}}">
        </firebase-document>

        <firebase-document app-name="doctor-appointment-system" path="/users/{{user.uid}}/address"
                           data="{{addressData}}">
        </firebase-document>

        <div class="main-frame">

            <div class="subsection grid" hidden="[[!signedIn]]">
                <section>
                    <h2>Základní informace</h2>
                    <paper-input id="fninput" label="Jméno" minlength="1" maxlength="20"
                                 error-message="Nelze ponechat prázdné" auto-validate required
                                 on-input="checkIfValid" value="[[nameData.firstName]]"></paper-input>
                    <paper-input id="lninput" label="Příjmení" minlength="1"
                                 maxlength="80" error-message="Nelze ponechat prázdné" auto-validate
                                 required on-input="checkIfValid" value="[[nameData.lastName]]"></paper-input>
                    <h2>Adresa</h2>
                    <paper-input id="cinput" label="Město" minlength="1" maxlength="20" value="[[addressData.city]]">
                    </paper-input>
                    <paper-input id="sinput" label="Město a číslo popisné" minlength="1" maxlength="80"
                                 value="[[addressData.street]]"></paper-input>
                    <custom-button>
                        <button id="confirm_button" type="button" on-tap="saveChanges">Uložit změny</button>
                    </custom-button>
                </section>

                <section>
                    <h2>Změna hesla</h2>
                    <p>Pro změnu hesla Vám zašleme email. V emailové zprávě bude odkaz, na kterém bude možno heslo změnit.</p>
                    <custom-button>
                        <button type="button" on-tap="passChange">Poslat email</button>
                    </custom-button>
                </section>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'account-view',

            behaviors: [InputValidationBehavior],

            validationIDs: ["fninput", "lninput"],

            properties: {
                signedIn: {
                    type: Boolean,
//                    observer: '_signedInChanged',
                    value: true
                },

                user: {
                    type: Object,
//                    observer: '_userChanged'
                },

                addressData: {
                    type: Object,
                },

                nameData: {
                    type: Object,
                    observer: 'checkIfValid'
                },
            },

            passChange: function () {
                this.domHost.$.auth.app.auth().sendPasswordResetEmail(this.user.email).then(function () {
                    this.domHost.showToast("Email odeslán");
                }.bind(this)).catch(function () {
                    console.log("email sending error");
                })
            },

            saveChanges: function () {
                this.set('nameData.firstName', this.$.fninput.value);
                this.set('nameData.lastName', this.$.lninput.value);
                this.set('addressData.city', this.$.cinput.value);
                this.set('addressData.street', this.$.sinput.value);
                this.domHost.showToast("Změny uloženy");
            }
        });
    </script>
</dom-module>
