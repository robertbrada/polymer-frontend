<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/paper-date-picker-item/paper-datetime-picker-item.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/polymerfire/firebase-document.html">
<link rel="import" href="/bower_components/moment-element/moment-import.html">

<link rel="import" href="/custom_components/moment-wrapper-cs.html">
<link rel="import" href="/styles/button-styles.html">

<dom-module id="holidays-view">
    <template>
        <style include="button-styles">
            .error {
                color: red;
            }
        </style>

        <firebase-document id="holidays_document" app-name="doctor-appointment-system" path="/officeHolidays/[[officeId]]"
                           data="{{officeHolidays}}">
        </firebase-document>


        <paper-input id="name_input" label="Název dovolené" value="{{holidayName}}" auto-focus required auto-validate></paper-input>
        <p class="error" hidden="[[hideErrorMessage]]">Začátek dovolené je před koncem.</p>
        <paper-datetime-picker-item required icon="icons:today" placeholder="Zadat začátek dovolené" default-time="00:00"
                                    locale="cs" date="{{fromDateTime}}"></paper-datetime-picker-item>
        <paper-datetime-picker-item icon="icons:today" placeholder="Zadat konec dovolené" default-time="23:59"
                                    locale="cs" date="{{toDateTime}}"></paper-datetime-picker-item>
        <paper-button raised on-tap="addHolidays" disabled="[[computeDisabled(fromDateTime, toDateTime, holidayName)]]">Přidat dovolenou
        </paper-button>

        <template is="dom-repeat" items="[[holidaysArray]]" as="holiday">
            <hr>
            <span>name: [[holiday.name]]</span><br>
            <span>startAt: [[holiday.startAt]]</span><br>
            <span>endAt: [[holiday.endAt]]</span><br>
            <span>hId: [[holiday.hId]]</span><br>
            <button on-tap="deleteHolidays">Odstranit</button>
        </template>
    </template>

    <script>
        Polymer({
            is: 'holidays-view',

            properties: {
                hideErrorMessage: {
                    type: Boolean,
                    value: true
                },

                holidaysArray: {
                    type: Array,
                    computed: 'computeHolidaysArray(officeHolidays)'
                }
            },

            computeHolidaysArray: function (officeHolidays) {
                var getFormattedDateTime = function (timestamp) {
                    return moment(timestamp).format('LLLL');
                };

                return Object.keys(officeHolidays).map(function (key) {
                    return {
                        'name': officeHolidays[key]['name'],
                        'startAt': getFormattedDateTime(Number(key)),
                        'endAt': getFormattedDateTime(officeHolidays[key]['endAt']),
                        'hId': key
                    }
                });
            },

            computeDisabled: function (fromDateTime, toDateTime, holidayName) {
                if (fromDateTime === null || toDateTime === null) {
                    this.hideErrorMessage = true;
                    return true;
                } else if (fromDateTime > toDateTime) {
                    this.hideErrorMessage = false;
                    return true
                } else if (!this.$.name_input.validate()) {
                    this.hideErrorMessage = true;
                    return true;
                }

                this.hideErrorMessage = true;

                return false;
            },

            addHolidays: function () {
                var postData = {
                    startAt: this.fromDateTime.valueOf(),
                    endAt: this.toDateTime.valueOf(),
                    name: this.holidayName,
                    officeId: this.officeId
                };

                this.getTokenAndSendRequest(postData, false);
            },

            deleteHolidays: function (event) {
                var postData = {
                    officeId: this.officeId,
                    holidayId: event.model.holiday.hId
                };

                this.getTokenAndSendRequest(postData, true);
            },

            getTokenAndSendRequest: function (postData, deletion) {
                this.$.holidays_document.app.auth().currentUser.getToken(true).then(function (idToken) {
                    postData["idToken"] = idToken;
                    if (deletion) {
                        this.sendDeletionRequest(postData);
                    } else {
                        this.sendAdditionRequest(postData);
                    }
                }.bind(this)).catch(function () {
                    this.showErrorDialog('Nepodařilo se získat autorizační token. Zkuste se odhlásit a přihlásit.');
                }.bind(this));
            },

            sendAdditionRequest: function (postData) {
                var request = new XMLHttpRequest(),
                    jsonResponse;

                request.onerror = function () {
                    this.showErrorDialog('Při ukládání dovolené se vyskytla chyba. Pravděpodobně se vyskytl problém s internetovým připojením.' +
                        'Zkuste to prosím znovu.');
                }.bind(this);

                request.onreadystatechange = function () {
                    if (request.readyState === XMLHttpRequest.DONE && request.status === 200) {
                        jsonResponse = JSON.parse(request.responseText);
                        if (jsonResponse["success"]) {
                            this.fire("show-toast", {text: "Požadavek se zpracovává"});
                        } else {
                            this.showErrorDialog('Při ukládání dovolené se vyskytla chyba. Zkuste to prosím znovu.');
                        }
                    }
                }.bind(this);

                // TODO: enable pre-flight request redirection when CORS standard catches up
                request.open("POST", "https://doctor-appointment-system.appspot.com/holiday/add", true);

                request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

                request.send(JSON.stringify(postData));
            },

            sendDeletionRequest: function (postData) {
                var request = new XMLHttpRequest(),
                    jsonResponse;

                request.onerror = function () {
                    this.showErrorDialog('Při odstraňování dovolené se vyskytla chyba. Pravděpodobně se vyskytl problém s internetovým připojením.' +
                        'Zkuste to prosím znovu.');
                }.bind(this);

                request.onreadystatechange = function () {
                    if (request.readyState === XMLHttpRequest.DONE && request.status === 200) {
                        jsonResponse = JSON.parse(request.responseText);
                        if (jsonResponse["success"]) {
                            this.fire("show-toast", {text: "Požadavek se zpracovává"});
                        } else {
                            this.showErrorDialog('Při odstraňování dovolené se vyskytla chyba. Zkuste to prosím znovu.');
                        }
                    }
                }.bind(this);

                // TODO: enable pre-flight request redirection when CORS standard catches up
                request.open("POST", "https://doctor-appointment-system.appspot.com/holiday/delete", true);

                request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

                request.send(JSON.stringify(postData));
            },

            showErrorDialog: function (message) {
                this.fire("show-dialog", {
                    path: "", viewName: "genericdialog", open: true,
                    data: {
                        text: message,
                        buttonText: 'Zavřít'
                    }
                });
            }
        });
    </script>
</dom-module>
