<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/polymerfire/firebase-document.html">
<link rel="import" href="/bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="/bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="/bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="/bower_components/polymerfire/firebase-document.html">

<link rel="import" href="/styles/input-styles.html">
<link rel="import" href="/styles/layout-styles.html">
<link rel="import" href="/styles/button-styles.html">
<link rel="import" href="/styles/settings-styles.html">

<link rel="import" href="/behaviors/form-validation-behavior.html">

<dom-module id="generator-info-view">
    <template>
        <style include="button-styles layout-styles input-styles settings-styles">

            .note {
                padding: 1em;
                margin: 1em 0;
                text-align: left;
            }

            .green-container {
                border: 1px solid var(--app-green-color);
                color: var(--app-green-color);
            }

            .note h2 {
                margin-top: 0;
            }

            a {
                text-decoration: none;
                color: var(--app-green-color);
            }

            #manual-change {
                color: var(--app-green-color);
            }

            #manual-change-checkbox {
                --primary-color: var(--app-green-color);
                margin-top: 2em;
            }

            #manual-change-input {
                position: relative;
                display: inline-block;
                margin-left: 1em;
                max-width: 11em;
                margin-bottom: 0;
                --paper-input-container-underline-focus: {
                    background-color: var(--app-green-color);
                    height: 2px;
                };

                --paper-input-container-input: {
                    margin-bottom: 0;
                    padding: 0;
                };

                --paper-input-container: {
                    margin-top: 0;
                    margin-bottom: 0;
                    padding: 0;
                };
            }

        </style>

        <firebase-document id="generator_document" app-name="doctor-appointment-system" path="/generatorInfo/[[officeId]]"
                           data="{{generatorInfo}}">
        </firebase-document>

        <form id="generator_form" is="iron-form" class="main-frame">
            <div class="note">
                <h2>Poznámka</h2>
                <p>Toto nastavení slouží k nastavení dlouhodobé, nebo trvalé změny.
                    Pokud chcete upravit např. pouze konkrétní den, týden (dovolená), tak doporučujeme provést změnu v
                    <a href="#">kalendáři</a>.</p>
            </div>
            <div class="note green-container">
                <h2>Důležité</h2>
                <p>Vámi provedená změna se automaticky projeví až v době, kdy nebude mít vliv na žádného,
                    již objednaného, pacienta.
                    Pokud si přejete provést změny od konkrétního dne, tak zrušíme objednání
                    všech pacientů,
                    kterých se změna dotkne a pošleme jim upozornění, aby se objednali znovu.</p>
                <div id="manual-change">
                    <paper-checkbox id="manual-change-checkbox" checked="{{manualChange}}">Provést změny od konkrétního dne
                    </paper-checkbox>
                    <paper-input id="manual-change-input" disabled="[[!manualChange]]" auto-validate required="[[manualChange]]"
                                 placeholder="den.měsíc.rok"
                                 pattern="\d{1,2}.\d{1,2}.\d{4}"
                                 prevent-invalid-input allowed-pattern="[\d.]">

                        <!--po kliknuti na ikonu se asi zobrazi komponenta pick-up date-->
                        <paper-icon-button icon="today" suffix></paper-icon-button>
                    </paper-input>
                </div>
            </div>

            <div class="subsection grid">
                <section>

                    <h2>Délka návštěvy<span id="visit-length-tooltip" class="tooltip"><iron-icon icon="icons:help"></iron-icon>Vysvětlení</span></h2>
                    <paper-tooltip for="visit-length-tooltip" offset="0">Zde zadejte odhad délky návštěvy pacienta v minutách. Podle této hodnoty a ordinačních
                        hodin určíme objednávací časy.
                    </paper-tooltip>
                    <paper-input type="number" label="Délka návštěvy" min="1" max="360" required auto-validate
                                 value="{{copyOfGeneratorInfo.visitLength}}">
                        <div suffix>min</div>
                    </paper-input>

                    <h2>Počet objednávacích dní<span id="num-of-days-tooltip" class="tooltip"><iron-icon icon="icons:help"></iron-icon>Vysvětlení</span></h2>
                    <paper-tooltip for="num-of-days-tooltip" offset="0">Zadejte na jak daleko do budoucna se mohou pacienti objednat. <br><br>Pokud napíšete např. 7 dní, tak nebude možné objednat se na 8. den a dále od dnešního data.
                    </paper-tooltip>
                    <paper-input type="number" label="Počet dní" min="7" max="360" required auto-validate
                                 value="{{copyOfGeneratorInfo.numberOfDays}}">
                        <div suffix>dní</div>
                    </paper-input>


                </section>

                <section>
                    <h2>Ordinační hodiny</h2>

                    <template is="dom-repeat" items="[[copyOfGeneratorInfo.officeHours]]" as="entry">
                        <div>
                            <paper-checkbox checked="{{entry.available}}">[[getDayName(index)]]</paper-checkbox>

                            <template is="dom-if" if="[[entry.available]]">
                                <paper-input value="{{entry.hours}}" auto-validate required
                                             placeholder="07:30-12:30,13:30-15:30"
                                             pattern="([0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]-([0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9](,([0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]-([0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9])*"
                                             prevent-invalid-input allowed-pattern="[0-9,-:]"></paper-input>
                            </template>
                        </div>
                    </template>
                </section>
            </div>

            <paper-button id="confirm-button" on-tap="confirm" responsive raised>
                Uložit změny
            </paper-button>

        </form>
    </template>

    <script>
        Polymer({
            is: 'generator-info-view',

            behaviors: [FormValidationBehavior],

            properties: {
                days: {
                    type: Array,
                    value: ['Pondělí', 'Úterý', 'Středa', 'Čtvrtek', 'Pátek', 'Sobota', 'Neděle']
                },

                manualChange: {
                    type: Boolean,
                    value: false
                },

                // The generatorInfo is copied so that the changes are saved after the button is pressed.
                copyOfGeneratorInfo: {
                    type: Object,
                    computed: 'computeCopyOfGeneratorInfo(generatorInfo)'
                }

            },

            confirm: function () {
                if (this._validateForm(this.$.generator_form)) {
                    this.saveChanges(this.copyOfGeneratorInfo);
                } else {
                    this.fire("show-toast", {text: "Chybný formát"});
                }
            },

            saveChanges: function (updatedGeneratorInfo) {
                var db = this.$.generator_document.app.database(),
                    officeId = this.officeId;

                db.ref('/generatorInfo/' + officeId).update(updatedGeneratorInfo).then(function () {
                    this.fire("show-toast", {text: "Změny uloženy"});
                    this.regenerateExistingValues()
                }.bind(this), function () {
                    this.fire("show-dialog", {
                        path: "", viewName: "genericdialog", open: true,
                        data: {
                            text: 'Při ukládání změn se vyskytla chyba. Zkuste to prosím znovu.',
                            buttonText: 'Zavřít'
                        }
                    });
                }.bind(this))
            },

            regenerateExistingValues: function () {
                // TODO: regenerate values
            },

            computeCopyOfGeneratorInfo: function (generatorInfo) {
                return generatorInfo;
            },

            getDayName: function (dayIndex) {
                return (this.days[dayIndex]);
            }
        });
    </script>
</dom-module>
