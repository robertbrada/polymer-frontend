<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-input/paper-textarea.html">
<link rel="import" href="/bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/gold-email-input/gold-email-input.html">
<link rel="import" href="/bower_components/gold-phone-input/gold-phone-input.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<!--<link rel="import" href="/bower_components/file-input/file-input.html">-->
<link rel="import" href="/bower_components/polymerfire/firebase-document.html">

<link rel="import" href="/styles/input-styles.html">
<link rel="import" href="/styles/layout-styles.html">
<link rel="import" href="/styles/button-styles.html">
<link rel="import" href="/styles/settings-styles.html">

<link rel="import" href="/behaviors/form-validation-behavior.html">

<!--TODO: name, coordinates, photo-->

<dom-module id="interface-settings-general-view">
    <template>
        <style include="button-styles layout-styles input-styles settings-styles">
        </style>

        <firebase-document id="office_document" app-name="doctor-appointment-system" path="/officeFullInfo/[[officeId]]"
                           data="{{officeFullInfo}}">
        </firebase-document>

        <form id="general_form" is="iron-form" class="main-frame">
            <div class="subsection grid">

                <section>
                    <h2>Adresa ordinace</h2>
                    <paper-input label="Město" value="{{localOfficeData.address.city}}"
                                 minlength="1" maxlength="20" auto-validate>
                    </paper-input>
                    <paper-input label="Ulice a číslo popisné" value="{{localOfficeData.address.street}}"
                                 minlength="1" maxlength="80" required auto-validate></paper-input>

                    <h2>Vaše specializace v této ordinaci</h2>
                    <paper-dropdown-menu label="Specializace">
                        <paper-listbox class="dropdown-content" selected="{{localOfficeData.specialization}}">
                            <template is="dom-repeat" items="[[specializations]]" as="entry">
                                <paper-item>[[entry]]</paper-item>
                            </template>
                        </paper-listbox>
                    </paper-dropdown-menu>

                    <h2>Přijímání nových pacientů</h2>
                    <p>Zaškrtněte, pokud přijímáte nové pacienty.</p>
                    <paper-checkbox checked="{{localOfficeData.acceptingNewPatients}}">
                        Přijímám nové pacienty
                    </paper-checkbox>

                    <h2>Manuální potvrzení při první návštěvě</h2>
                    <p>Zaškrtněte, pokud chcete, aby pacient při prvním objednání nejprve musel zažádat o Vaše potvrzení.
                        V případě, že jej zaškrtnete, pacient na Vašem profilu při prvním objednání bude muset zažádat o potvrzení. Poté
                        Vám přijde zpráva s žádostí o potvrzení. Ve zprávě uvidíte pacientovi osobní údaje (jméno, adresa), na základě
                        kterých umožníte pacientovi objednání či naopak. Při dalších pacientových návštěvách potvrzení nebude nutné.
                    </p>
                    <paper-checkbox checked="{{localOfficeData.manualConfirmation}}">
                        Manuální potvrzení
                    </paper-checkbox>
                </section>
                <section>

                    <h2>Vřejné informace profilu</h2>
                    <p>Zadejte prosím údaje, které si přejete zobrazit u Vašeho profilu. Tyto údaje jsou
                        dobrovolné tudíž je nemusíte vyplňovat/nahrávat.</p>
                    <p>Pokud chcete, aby se pacienti mohli objednat přes telefon, prosím vyplňte tuto
                        možnost:</p>
                    <gold-phone-input country-code="420" label="Telefonní číslo"
                                      phone-number-pattern="XXX-XXX-XXX" auto-validate
                                      value="{{localOfficeData.phoneNumber}}">
                    </gold-phone-input>
                    <gold-email-input label="Email" value="{{localOfficeData.email}}"
                                      auto-validate></gold-email-input>

                    <h2>Text pro pacienty</h2>
                    <p>Tento text se zobrazí na stránce Vaší ordinace. Můžete zde zadat libovolnou zprávu
                        pacientům. Zpráva není povinná.</p>
                    <paper-textarea label="Zpráva pro pacienty" value="{{localOfficeData.patientText}}"
                                    char-counter maxlength="800"></paper-textarea>

                </section>
            </div>

            <paper-button id="confirm-button" on-tap="confirm" responsive raised>
                Uložit změny
            </paper-button>
        </form>

    </template>

    <script>
        Polymer({
            is: 'interface-settings-general-view',

            behaviors: [FormValidationBehavior],

            properties: {
                specializations: {
                    type: Array,
                    value: ['Zubař', 'Rektálník', 'Gynekolog']
                },

                localOfficeData: {
                    type: Object,
                    computed: "computeLocalOfficeData(officeFullInfo)"
                }
            },

            computeLocalOfficeData: function (officeData) {
                return officeData;
            },

            confirm: function () {
                if (this._validateForm(this.$.general_form)) {
                    this.updateOfficeData(this.localOfficeData)
                }
            },

            updateOfficeData: function (localOfficeData) {
                var db = this.$.office_document.app.database(),
                    objectToSave = {}, officeId = this.officeId,
                    officeUserIds = null, i, officeName = '';

                db.ref('/officeAdminInfo/' + officeId + '/users').once('value').then(function (snapshot) {
                    officeUserIds = Object.keys(snapshot.val());
                    officeName = localOfficeData.address.city + ', ' + localOfficeData.address.street;

                    for (i = 0; i < officeUserIds.length; i++) {
                        objectToSave['/userOffices/' + officeUserIds[i] + '/' + officeId + '/name'] = officeName;
                    }

                    objectToSave['/officeFullInfo/' + officeId] = localOfficeData;
                    objectToSave['/officeSearchInfo/' + officeId] = {
                        'name': localOfficeData.name,
                        'address': localOfficeData.address,
                        'coordinates': localOfficeData.coordinates,
                        'acceptingNewPatients': localOfficeData.acceptingNewPatients,
                        'specialization': localOfficeData.specialization,
                        'photoAvailability': localOfficeData.photoAvailability
                    };

                    db.ref('/').update(objectToSave);

                }).then(function () {
                    this.fire("show-toast", {text: "Změny uloženy"});
                }.bind(this), function (error) {
                    // TODO: handle error
                    console.error(error);
                });
            }
        });
    </script>
</dom-module>
