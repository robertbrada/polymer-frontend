<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/polymerfire/firebase-document.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">

<link rel="import" href="/styles/input-styles.html">
<link rel="import" href="/styles/layout-styles.html">
<link rel="import" href="/styles/button-styles.html">

<link rel="import" href="/behaviors/form-validation-behavior.html">

<dom-module id="settings-view">
    <template>
        <style include="button-styles layout-styles input-styles">
        </style>

        <firebase-document id="user_document" app-name="doctor-appointment-system"
                           path="/userInfo/[[user.uid]]" data="{{userInfo}}">
        </firebase-document>

        <firebase-document app-name="doctor-appointment-system"
                           path="/userContactedOffices/[[user.uid]]" data="{{userContactedOffices}}">
        </firebase-document>


        <div class="subsection grid">
            <section>
                <form id="form1" is="iron-form">
                    <h2>Základní informace</h2>
                    <paper-input id="fninput" label="Jméno" minlength="1" maxlength="30"
                                 error-message="Nelze ponechat prázdné" required auto-validate
                                 value="[[userInfo.name.firstName]]"></paper-input>
                    <paper-input id="lninput" label="Příjmení" minlength="1" auto-validate
                                 maxlength="30" error-message="Nelze ponechat prázdné"
                                 required value="[[userInfo.name.lastName]]"></paper-input>
                    <paper-input id="dinput" label="Datum narození" value="[[computeDateOfBirth(userInfo.dateOfBirth)]]" auto-validate required
                                 placeholder="24.5.1995" pattern="[0-9]{1,2}.[0-9]{1,2}.[0-9]{4}" prevent-invalid-input allowed-pattern="[0-9.]">
                    </paper-input>
                </form>
            </section>

            <section>
                <form id="form2" is="iron-form">
                    <h2>Adresa</h2>
                    <paper-input id="cinput" label="Město" minlength="1" maxlength="30"
                                 value="[[userInfo.address.city]]" required auto-validate>
                    </paper-input>
                    <paper-input id="sinput" label="Ulice a číslo popisné" minlength="3" maxlength="80"
                                 value="[[userInfo.address.street]]" required auto-validate></paper-input>
                    <paper-button id="confirm_button" on-tap="confirm" raised>Uložit změny</paper-button>
                </form>
            </section>
        </div>
        <div>
            <h2>Změna hesla</h2>
            <p>Pro změnu hesla Vám zašleme email. V emailové zprávě bude odkaz, na kterém bude možno heslo
                změnit.</p>
            <paper-button on-tap="passChange" raised>Poslat email</paper-button>
        </div>
    </template>

    <script>
        Polymer({
            is: 'settings-view',

            behaviors: [FormValidationBehavior],

            confirm: function () {
                var form1Validity = this._validateForm(this.$.form1),
                    form2Validity = this._validateForm(this.$.form2);

                if (form1Validity && form2Validity) {
                    this.saveChanges();
                }
            },

            passChange: function () {
                this.$.auth.auth.sendPasswordResetEmail(this.user.email).then(function () {
                    this.fire("show-toast", {text: "Email odeslán"});
                }.bind(this)).catch(function () {
                    console.log("email sending error");
                })
            },

            computeDateOfBirth: function (dateOfBirth) {
                return (!!dateOfBirth) ? "" + dateOfBirth.date + "." + dateOfBirth.month + "." + dateOfBirth.year : null;
            },

            saveChanges: function () {
                var rootRef = this.$.user_document.ref.root, objectToSave = {}, i, status,
                    uid = this.user.uid, officeIds = Object.keys(this.userContactedOffices),
                    dateArray = this.$.dinput.value.split('.'),
                    userInfo = {
                        'name': {
                            'firstName': this.$.fninput.value,
                            'lastName': this.$.lninput.value
                        },
                        'address': {
                            'city': this.$.cinput.value,
                            'street': this.$.sinput.value
                        },
                        'dateOfBirth': {
                            'date': Number(dateArray[0]),
                            'month': Number(dateArray[1]),
                            'year': Number(dateArray[2])
                        }
                    };

                objectToSave['/userInfo/' + uid] = userInfo;

                for (i = 0; i < officeIds.length; i++) {
                    status = this.userContactedOffices[officeIds[i]].status;
                    if (status === 'awaitsVerification') {
                        objectToSave['/officePatientsToVerify/' + officeIds[i] + '/' + uid] = userInfo;
                    } else if (status === 'visited') {
                        objectToSave['/officePatients/' + officeIds[i] + '/' + uid] = userInfo;
                    } else if (status === 'blocked') {
                        objectToSave['/officeBlockedPatients/' + officeIds[i] + '/' + uid] = userInfo;
                    }
                }

                rootRef.update(objectToSave).then(function () {
                    this.fire("show-toast", {text: "Změny uloženy"});
                }.bind(this), function (error) {
//                    TODO: generic error dialog, handle validation error
                    console.log("Error occured in user settings view")
                });
            }
        });
    </script>
</dom-module>
