<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/paper-input/paper-textarea.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/gold-email-input/gold-email-input.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="/bower_components/polymerfire/firebase-app-script.html">
<link rel="import" href="/bower_components/iron-form/iron-form.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">

<link rel="import" href="/styles/input-styles.html">
<link rel="import" href="/styles/layout-styles.html">

<dom-module id="bookinginfo-view">
    <template>
        <style include="layout-styles input-styles">
            :host {
                display: block;
                color: #757575;
            }

            .blue-background {
                background-color: #05adc3;
                color: #fff !important;
            }

            .green-text {
                color: #0f9d58;
            }

            .blue-text {
                color: #05adc3;
            }

            .yellow-text {
                color: #f9a825;
            }

            a {
                text-decoration: none;
                color: var(--app-light-green-color);
                font-weight: 500;
            }

            a:hover {
                text-decoration: underline;
            }

            paper-button {
                color: #fff;
                background-color: var(--app-light-green-color);
                margin: 1em auto;
                padding: 1em 1.5em;
            }

            p {
                font-weight: 100 !important;
            }

            .badge {
                border-radius: 100%;
                display: inline-block;
                font-weight: bold;
                line-height: 1.9em;
                text-align: center;
                vertical-align: middle;
            }

            h1 {
                letter-spacing: 0.03em;
                font-weight: 300;
                font-size: 2em;
                margin-top: 0;
                margin-bottom: 1.5em;
            }

            paper-button {
                transition: all 0.3s cubic-bezier(.25, .8, .25, 1);
                box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
            }

            #message-sent {
                font-weight: 400;
                font-size: 1.1em;
                margin: 0;
                padding: 0.9em;
            }

            .main-frame {
                max-width: 1380px;
                font-weight: lighter;
                padding: 0;
                margin: 0 auto;
            }

            .grid section {
                padding: 3em 5%;
                /*margin: 0 !important;*/
                position: relative;
            }

            section > p {
                font-size: 1.2em;
                line-height: 1.65em;
                font-weight: 100;
            }

            header {
                text-align: left;
                padding: 6em 0 10em 0;
                position: relative;
                border: none !important;
            }

            header > section {
                max-width: 700px;
                padding: 0 2em;
            }

            header img {
                position: absolute;
                right: 5%;
                bottom: 0;
                max-width: 40%;
            }

            header h1 {
                font-weight: 300;
                font-size: 2.5em;
                margin-bottom: 1em;
            }

            header p {
                font-size: 1.2em;
                max-width: 500px;
            }

            /******************/

            #how-it-works {
                padding: 3em 0;
            }

            #how-it-works p {
                max-width: 550px;
            }

            #how-it-works ul {
                list-style: none;
                padding-left: 0;
                margin-bottom: 1.5em;
            }

            #how-it-works ul li iron-icon {
                display: inline-block;
                width: 25px;
                margin-right: 1em;
                vertical-align: text-bottom;
                color: var(--app-light-green-color);
            }

            #how-it-works ul li {
                margin-top: 0.8em;
                letter-spacing: 0.03em;
                font-size: 1.1em;
                position: relative;
            }

            #how-it-works #strakova-link {
                display: inline-block;
                margin-top: 2em;
            }

            #how-it-works #newweb-link {
                font-weight: 500;
                color: #757575;
            }


            /********************/
            #not-sure-container {
                position: relative;
                margin-top: 0;
                padding-top: 1em;
                padding-bottom: 1em;
            }

            #not-sure-container h1 {
                margin-bottom: 0.7em;
            }

            #not-sure-container .main-frame {
                max-width: 800px;
                margin: 0 auto;
            }

            #not-sure-container .headline {
                font-weight: bolder;
                margin-top: 2.5em;
                padding-top: 1em;
                border-top: 1px solid #e2e2e3;
                display: block;
            }

            /***** OFFICE PRESENTATION ********/

            #why-booking-section {
                background-color: #fafafa;
                text-align: center;
                padding: 4em 2em 1em 2em;
                position: relative;
            }

            #why-booking-section h1 {
                display: inline-block;
                margin: 0 auto 2em auto;
                position: relative;
            }

            .why-booking-img {
                max-height: 48px;
                margin-bottom: 1em;
            }

            .header-div {
                text-align: center;
            }

            #why-booking-section .header-div h2 {
                border-radius: 10em;
                text-transform: uppercase;
                font-size: 1.1em;
                width: 13em;
                margin: 0 auto 1em auto;
            }

            #why-booking-section .description-div {
                text-align: left;
                font-size: 1.1em;
                letter-spacing: 0.025em;
                line-height: 1.5em;
            }


            #add-online-booking h2 {
                margin-bottom: 0;
                margin-top: 0;
                font-size: 1.3em;
            }

            #add-online-booking img {
                color: var(--app-accent-color);
                height: 30px;
                position: relative;
                bottom: -34px;
                z-index: 2;
            }

            /* REGISTRATION STEPS */

            #registration {
                background-color: #f9f9f9;
                text-align: center;
                font-size: 0.9em;
                position: relative;
            }

            #registration .main-frame {
                max-width: 700px;
                padding: 5.5em 1.5em;
                overflow: inherit;
            }

            #registration h1 {
                letter-spacing: 0.03em;
                text-align: left;
            }

            #registration .badge {
                height: 45px;
                width: 45px;
                font-size: 1.8em;
                margin-right: 2em;
                background-color: transparent;
            }

            #step-one {
                position: relative;
            }

            #step-one .arrow {
                position: absolute;
                width: 5.3em;
                left: -7.5em;
            }

            #step-one .badge {
                background-color: var(--app-light-green-color);
                color: #fff;
                box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
            }

            .step-container {
                margin: 3em auto;
                text-align: left;
            }

            .step-container .headline {
                font-size: 1.5em;
            }

            .step-container paper-button {
                background-color: var(--app-light-green-color);
                padding: 1.4em 2.4em;
                font-weight: bold;
                font-size: 1.1em;
                letter-spacing: 0.08em;
                margin: 0;
            }

            .vertical-align {
                margin-top: auto;
                margin-bottom: auto;
            }

            .top-align {
                margin-top: 0;
                margin-bottom: auto;
            }

            #step-three .headline {
                margin-top: 0.4em;
                font-weight: bold;
            }

            #step-three p {
                font-weight: 100;
                font-size: 1.3em;
            }

            /*** QUESTION FORM ***/

            #questionContainer {
                padding: 3em 1.5em;
            }

            #questionContainer h1 {
                letter-spacing: 0.02em;
                margin-top: 0.5em;
            }

            #questionContainer p {
                margin-bottom: 1.5em;
                font-size: 1.2em;
            }

            #questionContainer paper-button {
                margin-top: 2.5em;
            }

            form {
                max-width: 600px;
                margin: 0 auto;
            }

            /****** FLEX LAYOUT ****/

            .booking-flex-horizontal > section {
                text-align: justify;
            }

            .flex-horizontal, .booking-flex-horizontal {
                @apply(--layout-horizontal);
            }

            .flexchild {
                @apply(--layout-flex);
            }

            /*
           ---- MEDIA ----
           */

            @media (max-width: 1200px) {

                header h1 {
                    font-size: 1.6em;
                }
            }

            @media (max-width: 716px) {

                :host {
                    font-size: 0.85em;
                }

                .grid section {
                    padding: 7% 5%;
                }

                header paper-button {
                    display: block;
                    width: 16em;
                    text-align: center;
                    margin: 1em auto;
                }

                #who-can-book-section .arrow {
                    height: 40px;
                    bottom: -39px;
                }

                .why-booking-img {
                    max-height: 40px;
                }

                .badge {
                    line-height: 2.3em;
                }

                #registration {
                    font-size: 0.9em;
                }

                #overview ul li .arrow {
                    top: 15px;
                }

                #help p {
                    left: 0.5em;
                    right: 0.5em;
                }

                #header-headlines .badge {
                    width: 60px;
                    height: 60px;
                    line-height: 2.8em;
                }
            }

            @media (max-width: 980px) {

                .booking-flex-horizontal {
                    @apply(--layout-vertical);
                }

                header {
                    padding-top: 2em;
                    padding-bottom: 8em;
                }
            }

            @media (min-width: 767px) {

                paper-button:hover {
                    transform: scale(1.1);
                    box-shadow: 0 14px 28px rgba(0, 0, 0, 0.25), 0 10px 10px rgba(0, 0, 0, 0.22);
                }
            }
        </style>

        <iron-media-query query="max-width:460px" query-matches="{{mobileScreen}}"></iron-media-query>
        <iron-media-query query="max-width:716px" query-matches="{{smallScreen}}"></iron-media-query>
        <iron-media-query query="max-width:980px" query-matches="{{mediumScreen}}"></iron-media-query>

        <header class="blue-background">
            <img class="" src="../images/bookinginfo/office-calendar-computer.png">

            <div class="main-frame grid">
                <section>
                    <h1>
                        Online objednávání na Docta.cz
                    </h1>
                    <p>
                        Vyzkoušejte naše online objednávání. Budete mít přehled
                        o svých pacientech. Není třeba listovat kalendářem.
                        Vaši pacienti se objednají sami a Vy se můžete
                        nerušeně věnovat práci, která má smysl.
                    </p>
                </section>

            </div>
        </header>

        <section id="how-it-works">
            <div class="main-frame grid">
                <section>
                    <h1 class="blue-text">
                        Jak to funguje?
                    </h1>
                    <p>Nejprve se u nás zaregistrujete. Poté stačí vyplnit informace o Vaší ordinaci.
                        Následně vytvoříme bezplatný profil, který může vypadat třeba <a class="blue-text" href="/d/strakova_plzen">takto</a>.
                        Objednávací kalendář je dobrovolný, můžete si tak vytvořit třeba jen profil s informacemi pro pacienty.</p>
                    <p>Informace na profilu si můžete upravit kdykoli a jakkoli uznáte za vhodné.
                    </p>

                    <a id="strakova-link" class="blue-text" href="/d/strakova_plzen">TAKTO MŮŽE VYPADAT VÁŠ PROFIL ZDARMA
                        <iron-icon icon="icons:forward"></iron-icon>
                    </a>

                </section>

                <section>
                    <h1 class="green-text">
                        Co obsahuje bezplatný profil?
                    </h1>
                    <ul>
                        <li>
                            <iron-icon icon="check"></iron-icon>
                            Veškeré kontaktní informace
                        </li>
                        <li>
                            <iron-icon icon="check"></iron-icon>
                            Seznam smluvních pojišťoven
                        </li>
                        <li>
                            <iron-icon icon="check"></iron-icon>
                            Upozornění na dovolenou
                        </li>
                        <li>
                            <iron-icon icon="check"></iron-icon>
                            Ordinační hodiny
                        </li>
                        <li>
                            <iron-icon icon="check"></iron-icon>
                            Poskytované služby a jejich ceny
                        </li>
                        <li>
                            <iron-icon icon="check"></iron-icon>
                            Libovolná zpráva pacientům
                        </li>
                        <li>
                            <iron-icon icon="check"></iron-icon>
                            Objednávací kalendář
                        </li>
                        <li>
                            <iron-icon icon="star" style="color: #f9a825"></iron-icon>
                            Něco Vám chybí? <span on-tap="scrollToForm" style="text-decoration: underline; cursor: pointer">Dejte nám vědět!</span>
                        </li>
                    </ul>

                </section>
            </div>
        </section>

        <section id="why-booking-section">
            <h1>Proč používat online objednávání?
            </h1>
            <div class="main-frame booking-flex-horizontal grid">
                <section>
                    <div class="header-div">
                        <img class="why-booking-img" src="../images/docinfo/save-time-ns.png">
                        <h2 class="yellow-text">Ušetříte si čas</h2>
                    </div>
                    <div class="description-div">
                        <p>Nezatěžujte sebe nebo Vaší sestru vyřizováním telefonátů. Vaši pacienti se objednají sami,
                            můžete se tak plně věnovat
                            práci, která má smysl.</p>
                    </div>
                </section>
                <section>
                    <div class="header-div">
                        <img class="why-booking-img" src="../images/docinfo/save-work-ns.png">
                        <h2 class="blue-text">Ušetříte si práci</h2>
                    </div>
                    <div class="description-div">
                        <p>Vytvoříme Vám kalendář přesně podle Vašich potřeb. Nemusíte listovat v papírech, vše budete
                            mít přehledně na jednom
                            místě.</p>
                    </div>
                </section>
                <section>
                    <div class="header-div">
                        <img class="why-booking-img" src="../images/docinfo/help-patients-ns.png">
                        <h2 class="green-text">Pomůžete pacientům</h2>
                    </div>
                    <div class="description-div">
                        <p>Pacienti se chtějí objednat kdy se jim to hodí. Dopřejte jim čas na rozmyšlenou a nenuťte je
                            telefonovat během
                            Vašich ordinačních hodin.</p>
                    </div>
                </section>
            </div>
        </section>
        <section id="not-sure-container">
            <div class="main-frame grid">
                <section>
                    <h1 class="green-text">Kdo se k Vám může objednat?</h1>
                    <p>Objednat se mohou jen pacienti, kteří jsou u nás zaregistrovaní.
                        Navíc si můžete sami vybírat,
                        kteří pacienti se k Vám mohou objednat a kteří ne. U každého pacienta uvidíte
                        informace k jeho identifikaci.
                        Můžete tak dovolit objednání jen svým pacientům.
                    </p>
                    <br>
                    <br>
                    <br>
                    <br>
                    <h1 class="blue-text">Nevíte, zda objednávání využijete?</h1>
                    <p>Naše online objednávání je zcela bezplatné. Nezáleží tak na tom, jak moc jej Vaši klienti
                        využijí. Až u Vás klienti tuto službu zaregistrují, uvidíte nárůst objednaných pacientů.</p>

                    <p><a href="[[registrationUrl]]">
                        <span hidden="[[signedIn]]">Registrace </span>
                        <span hidden="[[!signedIn]]">Přidání ordinace </span>
                    </a>Vám zabere jen 10 minut a naše služby můžete využít kdykoli.</p>

                    <p>
                        <span class="light-blue-text headline">Už máte vlastní stránku a chcete využít online objednávání?</span>
                        Rádi Vám pomůžeme vložit odkaz na Vaše stránky. Pokud máte zájem,
                        <a href="[[registrationUrl]]">
                            <span hidden="[[signedIn]]">zaregistrujte se</span>
                            <span hidden="[[!signedIn]]">přidejte ordinaci</span>
                        </a> a napište nám.
                    </p>

                    <br>
                    <br>

                </section>
            </div>
        </section>

        <section id="registration" class="light-blue-background">
            <div class="main-frame">
                <h1 class="green-text">Jak začít objednávat online?</h1>
                <section id="registration-steps-section">
                    <div style="margin: 0 auto">
                        <div id="step-one" class="step-container flex-horizontal">
                            <img class="arrow" src="../images/bookinginfo/right-arrow-green.png" hidden="[[mediumScreen]]">
                            <a href="[[registrationUrl]]" class="vertical-align badge" hidden="[[signedIn]]">
                                1
                            </a>
                            <a href="[[registrationUrl]]" class="flexchild">
                                <paper-button raised>[[computeButtonText(signedIn)]]</paper-button>
                            </a>
                        </div>
                        <div id="step-two" class="step-container flex-horizontal" hidden="[[signedIn]]">
                            <div class="badge">2</div>
                            <div class="flexchild headline vertical-align">PŘIDEJTE SVOU ORDINACI</div>
                        </div>
                        <div id="step-three" class="step-container flex-horizontal" hidden="[[signedIn]]">
                            <div class="badge top-align">3</div>
                            <div class="flexchild">
                                <div class="headline">HOTOVO!</div>
                                <p>Vaše ordinace je na internetu! Věříme, že budete spokojeni.</p></div>
                        </div>
                    </div>
                </section>
            </div>
        </section>

        <div id="questionContainer" hidden="[[messageSent]]">
            <form id="docinfo_form" is="iron-form">
                <h1>Napište nám</h1>
                <p>Chcete se na něco zeptat, nebo nám chcete sdělit cokoli jiného?</p>

                <gold-email-input id="email_input" error-message="Špatný formát"
                                  label="Vaše emailová adresa" required>
                </gold-email-input>
                <paper-textarea id="message_input" label="Vaše zpráva" char-counter
                                error-message="Zpráva nesmí být prázdná"
                                maxlength="2000" required></paper-textarea>
                <paper-button raised on-tap="send">Odeslat</paper-button>
            </form>
        </div>

        <p class="blue-background" id="message-sent" hidden="[[!messageSent]]">Zpráva odeslána, děkujeme. Co nejdříve se Vám ozveme.</p>

    </template>

    <script>
        Polymer({
            is: 'bookinginfo-view',

            properties: {
                database: {
                    type: Object,
                    value: function () {
                        return firebase.apps[0].database();
                    }
                },

                messageSent: {
                    type: Boolean,
                    value: false
                },

                trackingId: {
                    type: String,
                    notify: true,
                    computed: "computeId(ip, route)"
                },

                // Used to determine if the id was actually updated or not
                oldTrackingId: {
                    type: String,
                    value: null
                },

                ip: {
                    type: String,
                    value: null
                },

                registrationUrl: {
                    type: String,
                    computed: "computeUrl(signedIn)"
                },

                idComputed: {
                    type: Boolean,
                    value: false
                }

            },

            observers: [
                "saveUserInfo(ip, trackingId)",
                "saveRoute(route, trackingId)"
            ],


            ready: function () {
                var xhr = new XMLHttpRequest(),
                    setIp = function (e) {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            var response = JSON.parse(xhr.responseText);
                            this.ip = response.ip;
                        }
                    }.bind(this);

                xhr.open('GET', "//ipinfo.io/json", true);
                xhr.send();
                xhr.addEventListener("readystatechange", setIp, false);
            },

            computeId: function (ip, route) {
                if (!this.idComputed) {
                    var path = route.path;
                    if (route.prefix === "/docinfo" && path.length > 1) {
                        this.idComputed = true;
                        return path.substring(1);
                    } else if (!!ip) {
                        this.idComputed = true;
                        return this.ip.replace(/[.]/g, "-");
                    }
                }
                return this.trackingId;
            },

            saveUserInfo: function (ip, trackingId) {
                if (trackingId !== this.oldTrackingId && !!ip) {
                    this.oldTrackingId = trackingId;

                    var getBrowser = function () {
                            var ua = navigator.userAgent, tem, M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
                            if (/trident/i.test(M[1])) {
                                tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
                                return {name: 'IE', version: (tem[1] || '')};
                            }
                            if (M[1] === 'Chrome') {
                                tem = ua.match(/\bOPR|Edge\/(\d+)/);
                                if (tem !== null) {
                                    return {name: 'Opera', version: tem[1]};
                                }
                            }
                            M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
                            if ((tem = ua.match(/version\/(\d+)/i)) !== null) {
                                M.splice(1, 1, tem[1]);
                            }
                            return M[0] + " " + M[1];
                        },
                        objectToSave = {
                            ip: ip,
                            browser: getBrowser(),

                            browserLanguage: navigator.language,
                            browserPlatform: navigator.platform,

                            screenWidth: screen.width,
                            screenHeight: screen.height,
                            availableScreenWidth: innerWidth,
                            availableScreenHeight: innerHeight
                        };

                    this.database.ref("/docInfoVisitors/" + trackingId + "/userInfo").update(objectToSave);
                }
            },

            saveRoute: function (route, trackingId) {
                var objectToSave = {
                    URL: route.prefix + route.path,
                    datetime: new Date().toString()
                };

                this.database.ref("/docInfoVisitors/" + trackingId).push(objectToSave);
            },

            computeUrl: function (signedIn) {
                return (signedIn) ? "/office/registration/first" : "/registration/doc";
            },

            computeButtonText: function (signedIn) {
                return (signedIn) ? "Přidat ordinaci" : "Zaregistrujte se";
            },

            send: function () {
                //  paper-textarea was not detected by form validation, so I'm validating the inputs manually
                if (this.$.email_input.validate() && this.$.message_input.validate()) {
                    this.sendQuestion();
                }
            },

            sendQuestion: function () {

                var email = this.$.email_input.value,
                    message = this.$.message_input.value,
                    db = firebase.apps[0].database();

                db.ref('/docInfoQuestions/').push({
                    "email": email,
                    "message": message
                }).then(function () {
                    this.fire("show-toast", {text: "Zpráva odeslána"});
                    this.messageSent = true;
                }.bind(this), function () {
                    this.fire("show-dialog", {
                        path: "", viewName: "genericdialog", open: true,
                        data: {
                            text: 'Při ukládání dat se vyskytla chyba. Zkuste to prosím znovu.',
                            buttonText: 'Zavřít'
                        }
                    });
                }.bind(this));
            },

            scrollToForm: function () {
                this.$.questionContainer.scrollIntoView();
            }

        });
    </script>
</dom-module>
