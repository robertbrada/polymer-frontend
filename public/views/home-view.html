<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">

<!--icons-->
<link rel="import" href="../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../bower_components/iron-icons/maps-icons.html">

<link rel="import" href="/bower_components/polymerfire/firebase-app-script.html">

<link rel="import" href="/styles/input-styles.html">
<link rel="import" href="/styles/layout-styles.html">
<link rel="import" href="/styles/button-styles.html">

<dom-module id="home-view">
    <template>
        <style include="button-styles input-styles layout-styles">
            :host {
                display: block;
                --large-photo-width: 105px;
                --small-photo-width: 85px;
                background-color: #f8f8fa;
                margin-top: -3em
            }

            h1 {
                font-size: 1.6em;
                padding: 1.5em;
                color: #fff;
                background-color: var(--app-accent-color);
                margin: 2em 0 0;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            }

            #offlice-list {
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
                background-color: #fff;
            }

            /*** PROFILES ***/

            a {
                text-decoration: none;
                color: inherit;
            }

            .main-frame {
                margin-top: 3em;
                min-height: 100vh;
                max-width: 700px;
            }

            .office-element {
                padding: 1.8em;
                border-bottom: 1px solid #e0e0e1;
            }

            #profile-photo {
                height: 100%;
                width: 100%;
                border-radius: 50%;
            }

            #photo-container {
                width: var(--large-photo-width);
                height: var(--large-photo-width);
            }

            #name-address {
                margin-left: 2.5em;
                word-wrap: break-word;
                max-width: calc(100% - (110px + 220px)); /*100% width of container - width of photo and accept text + some space */
            }

            #name {
                font-weight: bold;
                font-size: 1.1em;
            }

            #specialization {
                color: #77787a;
                padding-bottom: 0.5em;
                border-bottom: 1px solid #e2e2e3;
            }

            #street {
                margin-top: 0.5em;
            }

            /*** ACCEPTING ***/

            .accepting-new-container {
                text-align: right;
                margin-left: auto;
            }

            paper-button iron-icon {
                margin-right: 0.2em;
            }

            .accepting-new-container iron-icon {
                margin-left: 0.5em;
                padding: 0.4em;
                border-radius: 50%;
                height: 18px;
                width: 18px;
                color: #fff;
            }

            #accepting, #not-accepting {
                color: #88888a;
            }

            #accepting iron-icon {
                background-color: var(--app-green-color);
            }

            #not-accepting iron-icon {
                background-color: var(--app-red-color);
            }

            /*** OTHER ***/

            #show-profile {
                font-size: 0.9em;
                display: block;
                margin-top: 2.4em;
                margin-bottom: 0;
            }

            #show-profile paper-button {
                margin: 0;
                color: #7a7a7b;
                border: 1px solid #d2d2d3;
                background-color: #fff;
                transition: all 0.3s cubic-bezier(.25, .8, .25, 1);
            }

            .office-element:hover #show-profile paper-button {
                color: #fff;
                border-color: var(--app-green-color);
                background-color: var(--app-green-color);
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            }

            .flex-horizontal-with-ratios {
                @apply(--layout-horizontal);
            }

            @media only screen and (max-width: 767px) {

                .main-frame {
                    padding-left: 0;
                    padding-right: 0;
                }

                h1 {
                    font-size: 1.1em;
                    margin-top: 0;
                }
            }

            @media only screen and (max-width: 585px) {

                .office-element {
                    position: relative;
                    font-size: 0.88em;
                    padding: 1em;
                    margin: 0;
                }

                #name-address {
                    margin-left: 1.5em;
                    max-width: calc(100% - (85px + 60px));
                }

                /* link to doctor is over all office card and is transparent */
                #show-profile {
                    position: absolute;
                    background-color: rgba(0, 0, 0, 0);
                    margin: 0;
                    padding: 0;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                }

                #photo-container {
                    width: var(--small-photo-width);
                    height: var(--small-photo-width);
                }
            }


        </style>

        <iron-media-query query="max-width: 585px" query-matches="{{mobileScreen}}"></iron-media-query>

        <div id="main-container" class="main-frame container flex-horizontal">
            <h1>Vyberte si svého lékaře</h1>

            <div id="offlice-list">
                <template is="dom-repeat" items="[[officesArray]]" as="office">
                    <div class="office-element container flex-horizontal-with-ratios">

                        <div id="photo-container">
                            <template is="dom-if" if="[[!office.photoAvailability]]">
                                <img src$="[[office.photoUrl]]" id="profile-photo">
                            </template>
                        </div>

                        <div id="name-address">
                            <div id="name">[[computeFullName(office.name)]]</div>
                            <div id="specialization">[[office.specialization]]</div>
                            <div id="street">[[office.address.street]]</div>
                            <div id="city">[[office.address.city]]</div>
                        </div>

                        <div class="accepting-new-container">

                            <div hidden="[[!office.acceptingNewPatients]]" id="accepting">
                                <span hidden="[[mobileScreen]]">Přijímá nové pacienty</span>
                                <iron-icon icon="social:group"></iron-icon>
                            </div>
                            <div hidden="[[office.acceptingNewPatients]]" id="not-accepting">
                                <span hidden="[[mobileScreen]]">Nepřijímá nové pacienty</span>
                                <iron-icon icon="social:group"></iron-icon>
                            </div>

                            <a href="/d/[[office.officeId]]" id="show-profile">
                                <paper-button hidden="[[mobileScreen]]">Zobrazit profil</paper-button>
                            </a>
                        </div>
                    </div>
                </template>
            </div>
            <div>
                <paper-button raised on-tap="previous" disabled="[[previousDisabled]]">
                    Předchozí
                </paper-button>
                <paper-button raised style="float: right" on-tap="next"
                              disabled="[[nextDisabled]]">Další
                </paper-button>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'home-view',

            properties: {
                firebaseApp: {
                    type: Object,
                    value: firebase.apps[0]
                },

                officesArray: {
                    type: Array
                },

                // Number of offices to fetch on one page
                numberToFetch: {
                    type: Number,
                    value: 10
                },

                visitedIds: {
                    type: Array,
                    value: []
                },

                selectedIdIndex: {
                    type: Number
                },

                nextDisabled: {
                    type: Boolean,
                    value: true,
                    computed: "computeNextDisabled(officesArray)"
                },

                previousDisabled: {
                    type: Boolean,
                    value: true,
                    computed: "computePreviousDisabled(selectedIdIndex)"
                }
            },

/*            observers: [
                "setPhotos(firebaseApp, officesArray)"
            ],*/

            setPhotos: function (firebaseApp, officesArray) {
                var i, office;

                // TODO: promises

                for (i = 0; i < officesArray.length; i++) {
                    office = officesArray[i];

                    if (office.photoAvailability) {
                        firebaseApp.storage().ref("profilePhotos/" + office.officeId + ".jpg").getDownloadURL().then(function (url) {
                            console.log(url);
                            office.photoUrl = url;
                        }.bind(this)).catch(function (error) {
                            console.log(error);
                            this.photoUrl = "../images/doctor-" + office.sex + ".png";
                        });
                    }
                }
            },

            ready: function () {
                var officesArray, numberToFetch = this.numberToFetch, searchData;

                this.firebaseApp.database().ref('/officeSearchInfo/').orderByKey().limitToFirst(numberToFetch).once('value').then(function (snapshot) {
                    searchData = snapshot.val();

                    if (searchData !== null) {
                        officesArray = this.computeOfficesArray(searchData);
                        this.selectedIdIndex = 0;
                        this.push('visitedIds', officesArray[0].officeId);
                        this.set('officesArray', officesArray);
                    }
                }.bind(this));
            },

            next: function () {
                var officesArray = this.officesArray,
                    selectedIdIndex = this.selectedIdIndex,
                    key = officesArray[officesArray.length - 1].officeId;

                if (selectedIdIndex === this.visitedIds.length - 1) this.push('visitedIds', key);

                this.fetchData(key, 1);
            },

            previous: function () {
                var selectedIdIndex = this.selectedIdIndex - 1;

                if (selectedIdIndex >= 0) {
                    this.fetchData(this.visitedIds[selectedIdIndex], -1);
                }

            },

            fetchData: function (startKey, indexDifference) {
                var numberToFetch = this.numberToFetch, searchData;

                this.firebaseApp.database().ref('/officeSearchInfo/').orderByKey().limitToFirst(numberToFetch).startAt(startKey).once('value').then(function (snapshot) {
                    searchData = snapshot.val();

                    if (searchData !== null) {
                        this.set('officesArray', this.computeOfficesArray(searchData));
                        this.selectedIdIndex = this.selectedIdIndex + indexDifference;
                    }
                }.bind(this));
            },

            computeOfficesArray: function (officeSearchInfo) {
                return Object.keys(officeSearchInfo).map(function (key) {
                    var sex = officeSearchInfo[key]['sex'];
                    return {
                        'name': officeSearchInfo[key]['name'],
                        'sex': sex,
                        'address': officeSearchInfo[key]['address'],
                        'specialization': officeSearchInfo[key]['specialization'],
                        'photoAvailability': officeSearchInfo[key]['photoAvailability'],
                        'acceptingNewPatients': officeSearchInfo[key]['acceptingNewPatients'],
                        'officeId': key,
                        'photoUrl': "../images/doctor-" + sex + ".png"
                    }
                });
            },

            computeFullName: function (name) {
                return name.firstName + " " + name.lastName;
            },

            computeNextDisabled: function (officesArray) {
                return this.numberToFetch !== officesArray.length;
            },

            computePreviousDisabled: function (selectedIdIndex) {
                return selectedIdIndex === 0;
            }
        });
    </script>
</dom-module>