<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/paper-button/paper-button.html">

<link rel="import" href="/bower_components/polymerfire/firebase-document.html">
<link rel="import" href="/bower_components/polymerfire/firebase-auth.html">

<link rel="import" href="/styles/button-styles.html">

<dom-module id="calendar-disabled-element">
    <template>
        <style include="button-styles">
        </style>

        <firebase-auth id="auth" app-name="doctor-appointment-system" status-known="{{statusKnown}}" user="{{user}}"></firebase-auth>

        <firebase-document id="user_contacted_document" app-name="doctor-appointment-system"
                           path="/userContactedOffices/[[user.uid]]/[[officeId]]" data="{{userContactedOffice}}">
        </firebase-document>

        <div>
            <h3>[[content.title]]</h3>
            <p>[[content.mainText]]</p>
            <paper-button hidden="[[!content.buttonVisibility]]" on-tap="handleButtonEvent" raised>[[content.buttonText]]</paper-button>
        </div>

    </template>

    <script>
        Polymer({
            is: 'calendar-disabled-element',

            properties: {
                loggedIn: {
                    type: Boolean,
                    computed: 'computeLoggedInProperty(statusKnown, user)'
                },

                disabledCalendar: {
                    type: Boolean,
                    notify: true
                },

                patientStatus: {
                    type: String,
                    value: null,
                    notify: true,
                    computed: 'computePatientStatusProperty(userContactedOffice)',
                },

                content: {
                    type: Object,
                    computed: "computeContent(loggedIn, manualConfirmation, patientStatus)"
                },

                contentObjects: {
                    type: Object,
                    value: {
                        logIn: {
                            title: "Vyžadováno přihlášení",
                            mainText: "Pro objednání je vyžadováno přihlášení. Můžete se přihlásit kliknutím na tlačítko níže.",
                            buttonVisibility: true,
                            buttonText: "Přihlásit"
                        },

                        awaits: {
                            title: "Vyžadováno potvrzení",
                            mainText: "Pro objednání je nutné ověření od doktora. Doktor podle Vašich osobních údajů ověří, zda jste jeho pacient. " +
                            "Pro ověření prosímklikněte na tlačítko níže. Jakmile Vás doktor potvrdí, notifikujeme Vás. Poté se budete mociobjednat.",
                            buttonVisibility: true,
                            buttonText: "Požádat o potvrzení"
                        },

                        blocked: {
                            title: "Přístup zablokován",
                            mainText: "Doktor Vám zablokoval přístup k objednávání. Zřejmě nejste jeho pacientem.",
                            buttonVisibility: false
                        },

                        sent: {
                            title: "Žádost odeslána",
                            mainText: "Nyní prosím vyčkejte, než Vám doktor povolí přístup.",
                            buttonVisibility: false
                        }
                    }
                }
            },

            computeContent: function (loggedIn, manualConfirmation, patientStatus) {
                this.hidden = false;
                this.disabledCalendar = true;

                if (!loggedIn) {
                    return this.contentObjects.logIn;
                } else if (manualConfirmation) {
                    if (patientStatus === null) {
                        return this.contentObjects.awaits;
                    } else if (patientStatus === "awaitsVerification") {
                        return this.contentObjects.sent;
                    } else if (patientStatus === "blocked") {
                        return this.contentObjects.blocked;
                    }
                }

                this.disabledCalendar = false;
                this.hidden = true;
                return null;
            },

            handleButtonEvent: function () {
                if (this.loggedIn) {
                    this.requestVerification();
                } else {
                    this.fire("show-dialog", {path: "", viewName: "login", open: true});
                }
            },

            requestVerification: function () {
                var uid = this.user.uid, officeId = this.officeId,
                    db = this.$.auth.app.database(), objectToSave = {};


                db.ref('/userInfo/' + uid).once('value').then(function (snapshot) {

                    objectToSave['/userContactedOffices/' + uid + '/' + officeId + '/status'] = 'awaitsVerification';
                    objectToSave['/officePatientsToVerify/' + officeId + '/' + uid] = snapshot.val();

                    db.ref('/').update(objectToSave).then(function () {
                        return db.ref('/officeNumberOfNotifications/' + officeId).transaction(function (currentCount) {
                            return (currentCount === null) ? null : currentCount + 1;
                        });
                    })
                }).then(function () {
                    this.fire("show-toast", {text: "Žádost o potvrzení odeslána"});
                }.bind(this), function (error) {
                    this.fire("show-dialog", {
                        path: "", viewName: "genericdialog", open: true,
                        data: {
                            text: 'Při posílání žádosti o potvrzení se vyskytla chyba. Zkuste to prosím znovu.',
                            buttonText: 'Zavřít'
                        }
                    });
                });
            },

            computeLoggedInProperty: function (statusKnown, user) {
                return (statusKnown && !!user);
            },

            computePatientStatusProperty: function (userContactedOffice) {
                return (Object.keys(userContactedOffice).length === 1) ? userContactedOffice.status : null;
            }
        });
    </script>
</dom-module>
