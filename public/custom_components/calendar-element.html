<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/custom_components/time-prototype.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="/bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="/bower_components/neon-animation/animations/slide-from-right-animation.html">
<link rel="import" href="/bower_components/neon-animation/animations/slide-right-animation.html">
<link rel="import" href="/bower_components/neon-animation/animations/slide-from-left-animation.html">
<link rel="import" href="/bower_components/neon-animation/animations/slide-left-animation.html">

<dom-module id="calendar-element">
    <template>
        <style>
            :host {
                text-align: left;
            }

            paper-icon-button {
                color: var(--app-green-color);
            }

            #animated_calendar {
                @apply(--layout-horizontal);
                width: 90%;
            }

            #animated_calendar > section {
                @apply(--layout-flex);
            }

            #animated_calendar > section:not(:first-child) {
                border-left: 2px solid #ededee;
            }

            .wrapper {
                @apply(--layout);
            }

            .controls {
                padding-top: 2em;
            }

            .row {
                @apply(--layout);
                @apply(--layout-center-center);
            }

            .date {
                font-size: 0.8em;
            }

            button {
                color: black;
                text-align: center;
                text-decoration: none;
                font-size: 1.15em;
                width: 100%;
                cursor: pointer;
                line-height: 0;
                background-color: #f3f5f6;
                margin: 0.3em 0.55em;
                padding: 1.1em 0;
                border: 1px solid #d8dbdc;
            }

            button:hover {
                background-color: #d8dbdc;
            }

            button:active {
                background-color: #cad0d3;
                border-color: #b9c1c6;
            }

            button:focus {
                outline: none;
            }

            button[disabled] {
                background-color: inherit;
                border: none;
                cursor: auto;
            }

        </style>
        <div class="wrapper">
            <div class="controls">
                <paper-icon-button icon="chevron-left" on-tap="previous"></paper-icon-button>
            </div>
            <div id="animated_calendar">
                <template is="dom-repeat" items="{{computeDates(firstVisibleDate, numberOfColumns, officeHours)}}" as="date">
                    <section>
                        <div class="row">
                            [[date.nameOfTheDay]]
                        </div>
                        <div class="row date">
                            [[computeDate(date)]]
                        </div>

                        <template is="dom-repeat" items="{{computeBookTimes(date, visitLength, officeHours)}}" as="bookTime">
                            <div class="row">
                                <button on-tap="handleAppointment" data-args$="{{computeId(date, bookTime)}}" disabled="[[disabled]]">
                                    [[computeButtonText(bookTime)]]
                                </button>
                            </div>
                        </template>
                    </section>
                </template>
            </div>
            <div class="controls">
                <paper-icon-button icon="chevron-right" on-tap="next"></paper-icon-button>
            </div>
        </div>

    </template>

    <script>
        Polymer({
            is: 'calendar-element',

            behaviors: [Polymer.NeonAnimationRunnerBehavior, Polymer.IronResizableBehavior],

            properties: {
                officeHours: {
                    type: Object
                },

                visitLength: {
                    type: Number
                },

                officeLocalTime: {
                    type: Date,
                    value: new Date() // TODO: set local time based on office time zone
                },

                firstVisibleDate: {
                    type: Date,
                    value: new Date()
                },

                numberOfColumns: {
                    type: Number,
                    value: 1
                },

                days: {
                    type: Array,
                    value: ['Pondělí', 'Úterý', 'Středa', 'Čtvrtek', 'Pátek', 'Sobota', 'Neděle']
                },

                // Animation properties follow

                animationConfig: {
                    value: function () {
                        return {
                            'slideLeft': {
                                name: 'slide-left-animation',
                                node: this.$.animated_calendar
                            },
                            'slideFromRight': {
                                name: 'slide-from-right-animation',
                                node: this.$.animated_calendar
                            },
                            'slideRight': {
                                name: 'slide-right-animation',
                                node: this.$.animated_calendar
                            },
                            'slideFromLeft': {
                                name: 'slide-from-left-animation',
                                node: this.$.animated_calendar
                            }
                        }
                    }
                },

                hideCalendar: {
                    type: Boolean
                },

                animationNext: {
                    type: Boolean
                },

                dataReloadFinished: {
                    type: Boolean,
                    value: false
                },

                animationFinished: {
                    type: Boolean,
                    value: false
                }
            },

            listeners: {
                'neon-animation-finish': '_onNeonAnimationFinish',
                'iron-resize': '_onWidthChange'
            },

            observers: [
                '_stateChanged(dataReloadFinished, animationFinished)'
            ],

            handleAppointment: function (event) {
                this.fire('appointment-request', {"appointmentId": event.target.dataset.args})
            },

            next: function () {
                this.hideCalendar = true;
                this.animationNext = true;
                this.playAnimation('slideLeft');
                this.reloadData(1);
            },

            previous: function () {
                this.hideCalendar = true;
                this.animationNext = false;
                this.playAnimation('slideRight');
                this.reloadData(-1);
            },

            _onNeonAnimationFinish: function () {
                if (this.hideCalendar) {
                    this.$.animated_calendar.style.visibility = 'hidden';
                    this.hideCalendar = false;
                    this.animationFinished = true;
                }
            },

            _onWidthChange: function () {
                var numberOfColumns,
                    w = this.$.animated_calendar.offsetWidth;
                if (w > 0) {
                    numberOfColumns = w / 100 >> 0;
                    if (numberOfColumns > 7) numberOfColumns = 7;
                    else if (numberOfColumns === 0) numberOfColumns = 1;
                    this.numberOfColumns = numberOfColumns;
                }
            },

            _stateChanged: function (dataReloadState, animationFinishState) {
                if (dataReloadState && animationFinishState) {
                    this.$.animated_calendar.style.visibility = 'visible';
                    if (this.animationNext) {
                        this.playAnimation('slideFromRight');
                    } else {
                        this.playAnimation('slideFromLeft');
                    }
                    this.dataReloadFinished = false;
                    this.animationFinished = false;
                }
            },

            // If clicked next, next = 1. Otherwise -1
            reloadData: function (next) {
                var i = next * this.numberOfColumns;
                this.firstVisibleDate = new Date(this.firstVisibleDate.valueOf() + i * 86400000);
                console.log("TODO: Firebase data fetch + wait for them to reload");
                this.dataReloadFinished = true;
            },

            computeDates: function (firstVisibleDate, numberOfColumns, officeHours) {
                var date, i, dayIndex,
                    dates = [],
                    valOfFirstVisibleDate = firstVisibleDate.valueOf();

                for (i = 0; i < numberOfColumns; i++) {
                    date = new Date(valOfFirstVisibleDate + i * 86400000);
                    dayIndex = this.getDayIndex(date);
                    date["officeHours"] = officeHours[dayIndex];
                    date["nameOfTheDay"] = this.days[dayIndex];
                    dates.push(date);
                }
                return dates;
            },

            getDayIndex: function (date) {
                var day = date.getDay() - 1;
                return (day < 0) ? 6 : day;
            },

            computeBookTimes: function (date, visitLength) {
                var intervals, i, interval, currentTime, nextTime,
                    bookTimes = [];

                if (date.officeHours.available) {
                    intervals = this.computeIntervals(date.officeHours.hours);
                    for (i = 0; i < intervals.length; i++) {
                        interval = intervals[i];
                        currentTime = interval.from;
                        while (currentTime.isValidBookTime(interval, nextTime = generateIncrementedTime(currentTime, visitLength))) {
                            bookTimes.push(currentTime);
                            currentTime = nextTime;
                        }
                    }
                }
                return bookTimes;
            },

            computeIntervals: function (hours) {
                var i, timeVals,
                    intervals = [],
                    splittedHours = hours.split(',');

                for (i = 0; i < splittedHours.length; i++) {
                    timeVals = splittedHours[i].split('-');
                    intervals.push({"from": CustomTimeBuilder(timeVals[0]), "to": CustomTimeBuilder(timeVals[1])});
                }
                return intervals;
            },

            computeDate: function (date) {
                return date.getDate() + "." + (date.getMonth() + 1) + ".";
            },

            computeButtonText: function (bookTime) {
                return bookTime.hours + ":" + ((bookTime.minutes > 9) ? bookTime.minutes : "0" + bookTime.minutes);
            },

            computeId: function (date, bookTime) {
                var month = date.getMonth() + 1,
                    dayDate = date.getDate(),
                    hours = bookTime.hours,
                    minutes = bookTime.minutes;

                if (month < 10) month = "0" + month;
                if (dayDate < 10) dayDate = "0" + dayDate;
                if (hours < 10) hours = "0" + hours;
                if (minutes < 10) minutes = "0" + minutes;

                return "" + date.getFullYear() + month + dayDate + hours + minutes;
            }
        });
    </script>
</dom-module>
